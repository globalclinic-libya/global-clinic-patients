# ุงููุฑุญูุฉ 1: ุจูุงุก ุงูุชุทุจูู ุจุงุณุชุฎุฏุงู pnpm
FROM node:20-alpine AS builder

# ุนุฑูู ูุชุบูุฑุงุช ุงูุจูุฆุฉ ูู Railway (ุงุฎุชูุงุฑูุฉุ ููู ูููุฏุฉ ููุชุตุญูุญ)
ARG RAILWAY_SERVICE_NAME
ARG RAILWAY_ENVIRONMENT

WORKDIR /app

# ุณุฌู ูุนูููุงุช ุงูุจูุงุก
RUN echo "๐๏ธ Building $RAILWAY_SERVICE_NAME in $RAILWAY_ENVIRONMENT environment"

# ุงูุณุฎ ููู ุงูููู ุฃููุงู
COPY pnpm-lock.yaml ./

# ุงุณุชุฎุฏู cache mount ูุชุณุฑูุน ุงูุชุซุจูุช
RUN --mount=type=cache,id=s/4f4b8ecf-8b2a-40c5-b28f-51e93180ef5b-pnpm,target=/root/.pnpm-store \
    npm install -g pnpm@8 && \
    pnpm install --frozen-lockfile

# ุงูุณุฎ ุจุงูู ุงูููุฏ
COPY . .

# ุจูุงุก ุงููุดุฑูุน
RUN pnpm run build


# ุงููุฑุญูุฉ 2: ุฎุฏูุฉ ุงููููุงุช ุงูุซุงุจุชุฉ ุนุจุฑ nginx
FROM nginx:alpine

# ุชุซุจูุช bash ูุชูููู ุชูููุฐ ุฃูุงูุฑ shell
RUN apk add --no-cache bash

# ุงูุณุฎ ุงููููุงุช ุงููุจููุฉ ุฅูู ูุฌูุฏ nginx
COPY --from=builder /app/dist /usr/share/nginx/html

# ุงูุณุฎ ููู nginx ููุงูุจ
COPY nginx.conf /etc/nginx/conf.d/default.conf.template

# ูู ุจุชุนุฏูู ููู ุงูุฅุนุฏุงุฏุงุช ุจุงุณุชุฎุฏุงู PORT ุนูุฏ ุงูุชุดุบูู
CMD envsubst '${PORT}' < /etc/nginx/conf.d/default.conf.template > /etc/nginx/conf.d/default.conf && \
    nginx -g 'daemon off;'
